---
- name: Ensure directory is exists
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  loop: "{{ develop_configuration.directories }}"

- name: Check symlink destinations
  ansible.builtin.stat:
    path: "{{ item.dest }}"
  loop: "{{ develop_configuration.symbolic_links }}"
  loop_control:
    label: "{{ item.dest }}"
  register: symlink_dest_stats

- name: Remove existing directories that will become symlinks
  ansible.builtin.file:
    path: "{{ item.item.dest }}"
    state: absent
  loop: "{{ symlink_dest_stats.results }}"
  loop_control:
    label: "{{ item.item.dest }}"
  when: item.stat.exists and item.stat.isdir and not item.stat.islnk

- name: Create symbolic links
  ansible.builtin.file:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    state: link
    force: true
  loop: "{{ develop_configuration.symbolic_links }}"

- name: Ensure AI tool skills directories exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  loop: "{{ ai_skills.destinations }}"

- name: Check if AI skills source directory exists
  ansible.builtin.stat:
    path: "{{ ai_skills.src }}"
  register: ai_skills_src_stat

- name: Find AI skill entries
  ansible.builtin.find:
    paths: "{{ ai_skills.src }}"
    patterns: "*"
    file_type: any
  register: ai_skill_entries
  when: ai_skills_src_stat.stat.exists

- name: Create symbolic links for AI skills
  ansible.builtin.file:
    src: "{{ item.0.path }}"
    dest: "{{ item.1 }}/{{ item.0.path | basename }}"
    state: link
    force: true
  loop: "{{ ai_skill_entries.files | product(ai_skills.destinations) | list }}"
  loop_control:
    label: "{{ item.1 }}/{{ item.0.path | basename }}"
  when: ai_skill_entries.files is defined
